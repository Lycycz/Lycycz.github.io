I"Á<h3 id="program-stream-mappsm">Program Stream Map(PSM)</h3>

<p>å¯¹ psm header çš„è§£æä¸»è¦æ˜¯ä¸ºäº†ï¼Œè§£æå‡ºæµçš„æ˜ å°„å’Œå¯¹åº”å…³ç³»
<strong>packet_start_code_prefix</strong>
è¯¥å­—æ®µæ˜¯å€¼ä¸ºâ€™0000 0000 0000 0000 0000 0001â€™ (0x000001)çš„ä½ä¸²ã€‚
<strong>map_stream_id</strong>
8 ä½å­—æ®µï¼Œå€¼ä¸º 0xBC</p>

<blockquote>
  <p>data æŒ‡å‘ç¬¬ä¸€ä¸ªå­—èŠ‚</p>
  <h5 id="è®¡ç®—æŒ‡å‘-es_map-çš„ä½ç½®">è®¡ç®—æŒ‡å‘ es_map çš„ä½ç½®</h5>
  <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">program_stream_info_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">program_stream_info_length</span><span class="p">;</span>
</code></pre></div>  </div>
  <h5 id="è®¡ç®—-es_map-çš„é•¿åº¦">è®¡ç®— es_map çš„é•¿åº¦</h5>
  <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ç›´æ¥è·å–</span>
<span class="kt">int</span> <span class="n">element_stream_map_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
</code></pre></div>  </div>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// é€šè¿‡ä¸¤ä¸ªé•¿åº¦ç›¸å‡è·å–ï¼Œmedia-serveré‡‡å–æ­¤æ–¹æ³•</span>
<span class="kt">int</span> <span class="n">program_stream_map_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">program_stream_info_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">element_stream_map_length</span> <span class="o">=</span> <span class="n">program_stream_map_length</span> <span class="o">-</span> <span class="n">program_stream_info_length</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
</code></pre></div></div>
<blockquote>
  <p>[!info] media-server é‡‡ç”¨æ­¤ç§æ–¹å¼ï¼Œå¯èƒ½ç›´æ¥è·å–å¯¹éƒ¨åˆ†æµæœ‰è¯¯</p>
</blockquote>

<p><strong>æµç±»å‹å­—æ®µÂ  stream_type</strong>
8 ä½å­—æ®µï¼Œæ ¹æ®è¡¨ 2-29 è§„å®šäº†æµçš„ç±»å‹ã€‚è¯¥å­—æ®µåªèƒ½æ ‡å¿—åŒ…å«åœ¨ PES åˆ†ç»„ä¸­çš„åŸºæœ¬æµä¸”å–å€¼ä¸èƒ½ä¸º 0x05ã€‚</p>
<blockquote>
  <p>è¿™é‡Œæˆ‘ä»¬æš‚æ—¶æ ¹æ®å›½æ ‡ GB28181 ä¸­çš„å®šä¹‰å¯ä»¥çŸ¥é“
1ã€MPEG-4 è§†é¢‘æµï¼š 0x10ï¼›
2ã€H.264 è§†é¢‘æµï¼š 0x1Bï¼›
3ã€SVAC è§†é¢‘æµï¼š 0x80ï¼›
4ã€G.711 éŸ³é¢‘æµï¼š 0x90ï¼›
5ã€G.722.1 éŸ³é¢‘æµï¼š 0x92ï¼›
6ã€G.723.1 éŸ³é¢‘æµï¼š 0x93ï¼›
7ã€G.729 éŸ³é¢‘æµï¼š 0x99ï¼›
8ã€SVAC éŸ³é¢‘æµï¼š 0x9Bã€‚
å› ä¸ºèŠ‚ç›®æ˜ å°„æµå­—æ®µåªæœ‰åœ¨å…³é”®å¸§æ‰“åŒ…çš„æ—¶å€™ï¼Œæ‰ä¼šå­˜åœ¨ï¼Œæ‰€ä»¥å¦‚æœè¦åˆ¤æ–­ PS æ‰“åŒ…çš„æµç¼–ç ç±»å‹ï¼Œå°±æ ¹æ®è¿™ä¸ªå­—æ®µæ¥åˆ¤æ–­ã€‚</p>
</blockquote>

<p><strong>åŸºæœ¬æµæ ‡è¯†å­—æ®µÂ  elementary_stream_id</strong>
8 ä½å­—æ®µï¼ŒæŒ‡å‡ºè¯¥åŸºæœ¬æµæ‰€åœ¨ PES åˆ†ç»„çš„ PES åˆ†ç»„æ ‡é¢˜ä¸­ stream_id å­—æ®µçš„å€¼ã€‚</p>
<blockquote>
  <p>è¿™ä¸ªå­—æ®µçš„å®šä¹‰ï¼Œå…¶ä¸­ 0x(C0~DF)æŒ‡éŸ³é¢‘ï¼Œ0x(E0~EF)ä¸ºè§†é¢‘</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// è·³è¿‡elementary_stream_map_length å­—æ®µ</span>
<span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> 
    <span class="n">j</span> <span class="o">+</span> <span class="mi">4</span><span class="cm">/*element_stream_info_length*/</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="o">+</span><span class="n">element_stream_map_length</span> <span class="o">&amp;&amp;</span> 
    <span class="c1">// psm-&gt;stream ä¼šåœ¨ä¹‹å‰ç®—å‡ºæ¥</span>
    <span class="n">psm</span><span class="o">-&gt;</span><span class="n">stream_count</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">psm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> 
    <span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">element_stream_info_length</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">element_stream_info_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>

    <span class="n">stream_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
    <span class="n">elementary_stream_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

    <span class="cm">/*
    descroptor() çš„è§£æ
    */</span>
<span class="p">}</span>
</code></pre></div></div>

<p>PS system Map(Psm) åé¢ç´§è·Ÿçš„å°±æ˜¯ [[PSæµä¸­ å¯¹pes headerä¸­pts dtsä¿¡æ¯çš„è§£æ|Packietized Elementary Stream(PES)]]
![[pes header.png]]</p>
:ET